<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Home</title>
  <link rel="stylesheet" href="./admin_dashboard.css" />
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Dashboard</h2>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="#" class="active">Home Content</a></li>
        <li><a href="./admin_dashboard_about_us.html">About Content</a></li>
        <li><a href="./admin_dashboard_services.html">Services</a></li>
        <li><a href="./admin_dashboard_blog.html">Blog</a></li>
        <li><a href="./admin_dashboard_contact.html">Contact</a></li>
        <li><a href="./admin_dashboard_vacancy.html">Vacancy</a></li>
        <li><a href="./admin_dashboard_scholars.html">Scholars</a></li>
      </ul>
    </nav>
  </div>
  
  <div id="global-error" class="status-message" style="display: none;"></div>
  <button id="logout-btn" class="logout-btn">Logout</button>
  <main>
  <!-- Main Content Area -->
  <div class="main-content">
    <!-- Home Header Section -->
<section class="header-edit">
  <h2>Edit Header</h2>

  <!-- Edit Title -->
  <label for="home-header-title">Home Title:</label>
  <input type="text" id="home-header-title" placeholder="Enter new title">
  <button type="button" id="update-header-btn">
    Save Title 
    <span id="header-spinner" class="loading" style="display: none;"></span>
  </button>

  <div id="header-status" class="status-message"></div>

  <!-- Edit Logo -->
  <label for="home-header-image">Upload Logo:</label>
  <input type="file" id="home-header-image" accept="image/*">
  <img id="header-image-preview" class="preview-image" src="" alt="Header image preview" style="display: none;">
</section>


    <!-- Service 1 Section -->
    <section id="home-services">
      <h2>Edit Services</h2>
      <form id="home-services-form" enctype="multipart/form-data">
        <div class="service-form">
          <label for="service1-title">Title:</label>
          <input type="text" id="service1-title" name="service1-title" placeholder="Enter title" required>
          
          <label for="service1-description">Description:</label>
          <textarea id="service1-description" name="service1-description" placeholder="Enter description" required></textarea>
          
          <label for="service1-image">Upload Image:</label>
          <input type="file" id="service1-image" name="service1-image" accept="image/*">
          <img id="service-image-preview" class="preview-image" src="" alt="Service image preview">
          
          <div id="service-status" class="status-message"></div>
          <button type="button" id="update-service1-btn">
            Update Service 
            <span id="service-spinner" class="loading" style="display: none;"></span>
          </button>
        </div>
      </form>
    </section>

    <!-- Footer Section -->
    <section id="home-footer">
      <h2>Edit Footer</h2>
      <form id="home-footer-form">
        <label for="home-footer-text">Footer Text:</label>
        <textarea id="home-footer-text" name="home-footer-text" rows="2" cols="50">
          &copy; 2025 FutureTechTalent Business Solutions. All Rights Reserved.
        </textarea>
        
        <div id="footer-status" class="status-message"></div>
        <button type="button" id="update-footer-btn">
          Update Footer 
          <span id="footer-spinner" class="loading" style="display: none;"></span>
        </button>
      </form>
    </section>
  </div>
</main>
  <script>

    // Utility Functions
    function showStatus(elementId, message, isSuccess) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.color = isSuccess ? 'green' : 'red';
        element.style.display = 'block';
        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }
    }

    function setupImagePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      
      if (input && preview) {
        input.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }
    }

    function toggleLoading(isLoading, buttonId, spinnerId, statusId) {
      const button = document.getElementById(buttonId);
      const spinner = document.getElementById(spinnerId);
      const status = document.getElementById(statusId);
      
      if (button) button.disabled = isLoading;
      if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
      if (status && !isLoading) status.style.display = 'none';
    }

    // Content Loading
    async function loadCurrentContent() {
      try {
        // Load header content
        const headerResponse = await fetch(apiEndpoints.header, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });
        if (headerResponse.ok) {
          const headerData = await headerResponse.json();
          document.getElementById('home-header-title').value = headerData.title || '';
          if (headerData.image) {
            document.getElementById('header-image-preview').src = headerData.image;
            document.getElementById('header-image-preview').style.display = 'block';
          }
        }

        // Load service with ID 1
        const serviceResponse = await fetch(apiEndpoints.services.get(1), {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });
        if (serviceResponse.ok) {
          const serviceData = await serviceResponse.json();
          document.getElementById('service1-title').value = serviceData.title || '';
          document.getElementById('service1-description').value = serviceData.description || '';
          if (serviceData.image) {
            document.getElementById('service-image-preview').src = serviceData.image;
            document.getElementById('service-image-preview').style.display = 'block';
          }
        }

        // Load footer content
        const footerResponse = await fetch(apiEndpoints.footer, {
          headers: {
            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
          }
        });
        if (footerResponse.ok) {
          const footerData = await footerResponse.json();
          document.getElementById('home-footer-text').value = footerData.text || '';
        }
      } catch (error) {
        console.error("Error loading content:", error);
        showStatus('global-error', 'Failed to load content', false);
      }
    }

   //==========
   // Configuration
const backendUrl = 'https://my-website-backend-ixzh.onrender.com';
const apiEndpoints = {
  services: {
    get: (id) => `${backendUrl}/api/services/${id}`,
    update: (id) => `${backendUrl}/api/services/${id}`
  },
  header: `${backendUrl}/api/header`,
  footer: `${backendUrl}/api/footer`
};

// Enhanced Update Function with better file handling
async function updateContent(type, id, formData) {
  let buttonId, spinnerId, statusId, endpoint;
  
  // Set element IDs based on content type
  switch(type) {
    case 'service':
      buttonId = 'update-service1-btn';
      spinnerId = 'service-spinner';
      statusId = 'service-status';
      endpoint = apiEndpoints.services.update(id);
      break;
    case 'header':
      buttonId = 'update-header-btn';
      spinnerId = 'header-spinner';
      statusId = 'header-status';
      endpoint = apiEndpoints.header;
      break;
    case 'footer':
      buttonId = 'update-footer-btn';
      spinnerId = 'footer-spinner';
      statusId = 'footer-status';
      endpoint = apiEndpoints.footer;
      break;
    default:
      throw new Error('Invalid content type');
  }

  try {
    toggleLoading(true, buttonId, spinnerId, statusId);
    
    // Verify authentication token exists
    const token = localStorage.getItem('authToken');
    if (!token) {
      throw new Error('No authentication token found. Please login again.');
    }

    // Debug: Log what we're sending
    console.log(`Updating ${type} with data:`, Array.from(formData.entries()));

    const response = await fetch(endpoint, {
      method: 'PUT',
      headers: {
        'Authorization': `Bearer ${token}`
        // Note: Don't set Content-Type header when sending FormData
        // The browser will set it automatically with the correct boundary
      },
      body: formData
    });

    // Handle non-successful responses
    if (!response.ok) {
      let errorData;
      try {
        errorData = await response.json();
      } catch (e) {
        errorData = { message: await response.text() };
      }
      throw new Error(errorData.message || `Server responded with status ${response.status}`);
    }

    const result = await response.json();
    showStatus(statusId, `${type} updated successfully!`, true);
    return result;
  } catch (error) {
    console.error(`Error updating ${type}:`, error);
    showStatus(statusId, error.message || `Failed to update ${type}`, false);
    throw error;
  } finally {
    toggleLoading(false, buttonId, spinnerId, statusId);
  }
}

// Enhanced Header Update Handler
async function handleHeaderUpdate() {
  try {
    const formData = new FormData();
    
    // Add title - use the exact field name your backend expects
    formData.append('title', document.getElementById('home-header-title').value);
    
    // Handle file upload
    const imageFile = document.getElementById('home-header-image').files[0];
    if (imageFile) {
      // Use the exact field name your backend expects for the image
      formData.append('headerImage', imageFile);
      
      // Validate file size (example: limit to 2MB)
      if (imageFile.size > 2 * 1024 * 1024) {
        throw new Error('Image size must be less than 2MB');
      }
      
      // Validate file type
      if (!imageFile.type.match('image.*')) {
        throw new Error('Only image files are allowed');
      }
    }
    
    await updateContent('header', null, formData);
  } catch (error) {
    console.error('Header update failed:', error);
    showStatus('header-status', error.message, false);
  }
}

// Enhanced Service Update Handler
async function handleServiceUpdate() {
  try {
    const formData = new FormData();
    
    // Add service data - use exact field names your backend expects
    formData.append('title', document.getElementById('service1-title').value);
    formData.append('description', document.getElementById('service1-description').value);
    
    // Handle file upload
    const imageFile = document.getElementById('service1-image').files[0];
    if (imageFile) {
      // Use the exact field name your backend expects for the image
      formData.append('serviceImage', imageFile);
      
      // Validate file size (example: limit to 2MB)
      if (imageFile.size > 2 * 1024 * 1024) {
        throw new Error('Image size must be less than 2MB');
      }
      
      // Validate file type
      if (!imageFile.type.match('image.*')) {
        throw new Error('Only image files are allowed');
      }
    }
    
    await updateContent('service', 1, formData);
  } catch (error) {
    console.error('Service update failed:', error);
    showStatus('service-status', error.message, false);
  }
}

// Footer Update Handler (no file upload)
async function handleFooterUpdate() {
  try {
    const formData = new FormData();
    formData.append('text', document.getElementById('home-footer-text').value);
    await updateContent('footer', null, formData);
  } catch (error) {
    console.error('Footer update failed:', error);
    showStatus('footer-status', error.message, false);
  }
}
   //==========


    
    async function handleHeaderUpdate() {
  const formData = new FormData();
  // Use exact field names your backend expects
  formData.append('title', document.getElementById('home-header-title').value);
  
  const imageFile = document.getElementById('home-header-image').files[0];
  if (imageFile) {
    formData.append('headerImage', imageFile); // Match backend expected field name
  }
  
  await updateContent('header', null, formData);
}

    // Event Listeners Setup
    function setupEventListeners() {
      document.getElementById('update-service1-btn').addEventListener('click', handleServiceUpdate);
      document.getElementById('update-header-btn').addEventListener('click', handleHeaderUpdate);
      document.getElementById('update-footer-btn').addEventListener('click', handleFooterUpdate);
      
      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '/admin-login.html';
      });
    }

    // Initialization
    document.addEventListener("DOMContentLoaded", function() {
      if (!localStorage.getItem('authToken')) {
        window.location.href = '/admin-login.html';
        return;
      }

      setupImagePreview('home-header-image', 'header-image-preview');
      setupImagePreview('service1-image', 'service-image-preview');
      loadCurrentContent();
      setupEventListeners();
    });
  </script>
</body>
</html>