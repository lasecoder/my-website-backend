<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard - Home</title>
  <link rel="stylesheet" href="./admin_dashboard.css" />
</head>
<body>
  <!-- Sidebar Navigation -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>Admin Dashboard</h2>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="#" class="active">Home Content</a></li>
        <li><a href="./admin_dashboard_about_us.html">About Content</a></li>
        <li><a href="./admin_dashboard_services.html">Services</a></li>
        <li><a href="./admin_dashboard_blog.html">Blog</a></li>
        <li><a href="./admin_dashboard_contact.html">Contact</a></li>
        <li><a href="./admin_dashboard_vacancy.html">Vacancy</a></li>
        <li><a href="./admin_dashboard_scholars.html">Scholars</a></li>
      </ul>
    </nav>
  </div>
  
  <div id="global-error" class="status-message" style="display: none;"></div>
  <button id="logout-btn" class="logout-btn">Logout</button>
  <main>
    <!-- Main Content Area -->
    <div class="main-content">
      <!-- Home Header Section -->
      <section class="header-edit">
        <h2>Edit Header</h2>

        <!-- Edit Title -->
        <label for="home-header-title">Home Title:</label>
        <input type="text" id="home-header-title" placeholder="Enter new title">
        <button type="button" id="update-header-btn">
          Save Title 
          <span id="header-spinner" class="loading" style="display: none;"></span>
        </button>

        <div id="header-status" class="status-message"></div>

        <!-- Edit Logo -->
        <label for="home-header-image">Upload Logo:</label>
        <input type="file" id="home-header-image" accept="image/*">
        <img id="header-image-preview" class="preview-image" src="" alt="Header image preview" style="display: none;">
        <button type="button" id="update-header-logo-btn">
          Save Logo
          <span id="header-logo-spinner" class="loading" style="display: none;"></span>
        </button>
      </section>

      <!-- Service 1 Section -->
      <section id="home-services">
        <h2>Edit Services</h2>
        <form id="home-services-form" enctype="multipart/form-data">
          <div class="service-form">
            <label for="service1-title">Title:</label>
            <input type="text" id="service1-title" name="service1-title" placeholder="Enter title" required>
            
            <label for="service1-description">Description:</label>
            <textarea id="service1-description" name="service1-description" placeholder="Enter description" required></textarea>
            
            <label for="service1-image">Upload Image:</label>
            <input type="file" id="service1-image" name="service1-image" accept="image/*">
            <img id="service-image-preview" class="preview-image" src="" alt="Service image preview">
            
            <div id="service-status" class="status-message"></div>
            <button type="button" id="update-service1-btn">
              Update Service 
              <span id="service-spinner" class="loading" style="display: none;"></span>
            </button>
          </div>
        </form>
      </section>

      <!-- Footer Section -->
      <section id="home-footer">
        <h2>Edit Footer</h2>
        <form id="home-footer-form">
          <label for="home-footer-text">Footer Text:</label>
          <textarea id="home-footer-text" name="home-footer-text" rows="2" cols="50">
            &copy; 2025 FutureTechTalent Business Solutions. All Rights Reserved.
          </textarea>
          
          <div id="footer-status" class="status-message"></div>
          <button type="button" id="update-footer-btn">
            Update Footer 
            <span id="footer-spinner" class="loading" style="display: none;"></span>
          </button>
        </form>
      </section>
    </div>
  </main>

  <script>
    // Utility Functions
    function showStatus(elementId, message, isSuccess) {
      const element = document.getElementById(elementId);
      if (element) {
        element.textContent = message;
        element.style.color = isSuccess ? 'green' : 'red';
        element.style.display = 'block';
        setTimeout(() => {
          element.style.display = 'none';
        }, 5000);
      }
    }
  
    function setupImagePreview(inputId, previewId) {
      const input = document.getElementById(inputId);
      const preview = document.getElementById(previewId);
      if (input && preview) {
        input.addEventListener('change', function() {
          if (this.files && this.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
              preview.src = e.target.result;
              preview.style.display = 'block';
            };
            reader.readAsDataURL(this.files[0]);
          }
        });
      }
    }
  
    function toggleLoading(isLoading, buttonId, spinnerId, statusId) {
      const button = document.getElementById(buttonId);
      const spinner = document.getElementById(spinnerId);
      const status = document.getElementById(statusId);
  
      if (button) button.disabled = isLoading;
      if (spinner) spinner.style.display = isLoading ? 'inline-block' : 'none';
      if (status && !isLoading) status.style.display = 'none';
    }
  
    const backendUrl = 'https://my-website-backend-ixzh.onrender.com';
    const apiEndpoints = {
      services: {
        get: (id) => `${backendUrl}/api/services/${id}`,
        update: (id) => `${backendUrl}/api/services/${id}`
      },
      header: `${backendUrl}/api/header`,
      footer: `${backendUrl}/api/footer`
    };
  
    async function updateContent(type, id, formData) {
      let buttonId, spinnerId, statusId, endpoint;
  
      switch (type) {
        case 'service':
          buttonId = 'update-service1-btn';
          spinnerId = 'service-spinner';
          statusId = 'service-status';
          endpoint = apiEndpoints.services.update(id);
          break;
        case 'header':
          buttonId = 'update-header-btn';
          spinnerId = 'header-spinner';
          statusId = 'header-status';
          endpoint = apiEndpoints.header;
          break;
        case 'footer':
          buttonId = 'update-footer-btn';
          spinnerId = 'footer-spinner';
          statusId = 'footer-status';
          endpoint = apiEndpoints.footer;
          break;
        default:
          throw new Error('Invalid content type');
      }
  
      try {
        toggleLoading(true, buttonId, spinnerId, statusId);
  
        const token = localStorage.getItem('authToken');
        if (!token) throw new Error('No authentication token found. Please login again.');
  
        const response = await fetch(endpoint, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${token}`
          },
          body: formData
        });
  
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || `Server responded with status ${response.status}`);
        }
  
        const result = await response.json();
        showStatus(statusId, `${type} updated successfully!`, true);
        return result;
      } catch (error) {
        console.error(`Error updating ${type}:`, error);
        showStatus(statusId, error.message || `Failed to update ${type}`, false);
        throw error;
      } finally {
        toggleLoading(false, buttonId, spinnerId, statusId);
      }
    }
  
    // âœ… MISSING FUNCTIONS: Now included here!
    async function handleServiceUpdate() {
      const formData = new FormData();
      const title = document.getElementById('service1-title').value;
      const description = document.getElementById('service1-description').value;
      const imageFile = document.getElementById('service1-image').files[0];
  
      formData.append('title', title);
      formData.append('description', description);
      if (imageFile) formData.append('image', imageFile);
  
      await updateContent('service', 1, formData);
    }
  
    async function handleHeaderUpdate() {
      const formData = new FormData();
      const title = document.getElementById('home-header-title').value;
      const imageFile = document.getElementById('home-header-image').files[0];
  
      formData.append('title', title);
      if (imageFile) formData.append('image', imageFile);
  
      await updateContent('header', null, formData);
    }
  
    async function handleFooterUpdate() {
      const formData = new FormData();
      const text = document.getElementById('home-footer-text').value;
  
      formData.append('text', text);
      await updateContent('footer', null, formData);
    }
  
    async function loadCurrentContent() {
      try {
        const headerRes = await fetch(apiEndpoints.header, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
        });
        if (headerRes.ok) {
          const data = await headerRes.json();
          document.getElementById('home-header-title').value = data.title || '';
          if (data.image) {
            document.getElementById('header-image-preview').src = data.image;
            document.getElementById('header-image-preview').style.display = 'block';
          }
        }
  
        const serviceRes = await fetch(apiEndpoints.services.get(1), {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
        });
        if (serviceRes.ok) {
          const data = await serviceRes.json();
          document.getElementById('service1-title').value = data.title || '';
          document.getElementById('service1-description').value = data.description || '';
          if (data.image) {
            document.getElementById('service-image-preview').src = data.image;
            document.getElementById('service-image-preview').style.display = 'block';
          }
        }
  
        const footerRes = await fetch(apiEndpoints.footer, {
          headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
        });
        if (footerRes.ok) {
          const data = await footerRes.json();
          document.getElementById('home-footer-text').value = data.text || '';
        }
      } catch (error) {
        console.error("Error loading content:", error);
        showStatus('global-error', 'Failed to load content', false);
      }
    }
  
    function setupEventListeners() {
      document.getElementById('update-service1-btn').addEventListener('click', handleServiceUpdate);
      document.getElementById('update-header-btn').addEventListener('click', handleHeaderUpdate);
      document.getElementById('update-header-logo-btn').addEventListener('click', handleHeaderUpdate);
      document.getElementById('update-footer-btn').addEventListener('click', handleFooterUpdate);
      document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = '/admin-login.html';
      });
    }
  
    document.addEventListener("DOMContentLoaded", function() {
      if (!localStorage.getItem('authToken')) {
        window.location.href = '/admin-login.html';
        return;
      }
  
      setupImagePreview('home-header-image', 'header-image-preview');
      setupImagePreview('service1-image', 'service-image-preview');
      loadCurrentContent();
      setupEventListeners();
    });
  </script>
  
</body>
</html>
