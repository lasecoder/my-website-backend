<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Blog Management</title>
    <link rel="stylesheet" href="/admin_dashboard_blog.css">
</head>
<body>
    <header>
        <div class="container_blog">
            <div class="header-left">
                <a href="/index.html">
                    <img id="header-logo" src="/images/ftt.png" alt="Logo">
                </a>
                <h1 id="header-title-text">Admin Dashboard - Blog Management</h1>
            </div>
        </div>
    </header>
    
    <!-- Admin Dashboard Sidebar -->
    <div class="sidebar">
        <ul>
            <li><a href="/admin_dashboard.html">Home</a></li>
            <li><a href="/admin_dashboard_blog.html" class="active">Dashboard</a></li>
            <li><a href="/public/blog.html">View Blog</a></li>
            <li><a href="/logout.html">Logout</a></li>
        </ul>
    </div>

    <main>
      <!-- Add Header Editing Section -->
      <section class="header-edit">
        <h2>Edit Header</h2>
        
        <!-- Edit Title -->
        <label for="header-title">Blog Title:</label>
        <input type="text" id="header-title" placeholder="Enter new title">
        <button class="btn" onclick="saveHeaderTitle()">Save Title</button>
        
        <!-- Edit Logo -->
        <label for="logo-upload">Upload Logo:</label>
        <input type="file" id="logo-upload" accept="image/*">
        <button class="btn" onclick="saveLogo()">Save Logo</button>
    </section>

        <section class="dashboard-content">
            <h2>Manage Blog Posts</h2>
            
            <!-- Add New Post Button -->
            <button class="btn" onclick="showAddPostForm()">Add New Post</button>
            
            <!-- Add Post Form (hidden by default) -->
            <div id="add-post-form" class="post-form" style="display:none;">
                <h3>Add New Blog Post</h3>
                <form id="post-form" onsubmit="addPost(event)">
                    <label for="post-title">Title:</label>
                    <input type="text" id="post-title" required>
                    <label for="post-content">Content:</label>
                    <textarea id="post-content" required></textarea>
                    <label for="post-image">Image:</label>
                    <input type="file" id="post-image" accept="image/*">
                    <label for="post-video">Video:</label>
                    <input type="file" id="post-video" accept="video/*">
                    <button type="submit" class="btn">Save Post</button>
                    <button type="button" class="btn" onclick="cancelAddPost()">Cancel</button>
                </form>
            </div>

            <!-- Blog Posts Container -->
            <div class="posts-container" id="posts-container"></div>
        </section>

          <p id="footer-text">&copy; 2025 Your Business. All Rights Reserved.</p>
          <button class="btn edit-footer-btn" onclick="editFooter()">Edit Footer</button>
    </main>

    <footer>
        <p id="footer-display">&copy; 2025 Your Business. All Rights Reserved.</p>
    </footer>

    <script>
        // Function to save new header title
        function saveHeaderTitle() {
            let newTitle = document.getElementById("header-title").value;
            if (newTitle) {
                document.getElementById("header-title-text").textContent = newTitle;
                localStorage.setItem("headerTitle", newTitle);
                alert("Header title updated!");
            }
        }

        // Function to save new logo
        function saveLogo() {
            let fileInput = document.getElementById("logo-upload");
            let file = fileInput.files[0];

            if (file) {
                let reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById("header-logo").src = e.target.result;
                    localStorage.setItem("blogLogo", e.target.result);
                    alert("Logo updated successfully!");
                };
                reader.readAsDataURL(file);
            }
        }

        // Fetch posts from the backend API and display them
        async function fetchPosts() {
  try {
    const response = await fetch("/api/posts");
    
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const result = await response.json();
    
    // Check if we got valid data
    if (!result.success || !Array.isArray(result.data)) {
      throw new Error("Invalid posts data received");
    }

    const posts = result.data;
    const container = document.getElementById("posts-container");
    container.innerHTML = ""; // Clear existing posts
    
    // Handle empty posts case
    if (posts.length === 0) {
      container.innerHTML = "<p>No posts found. Add your first post!</p>";
      return;
    }

    // Render posts
    posts.forEach(post => {
      container.innerHTML += `
        <div class="post" id="post-${post._id}">
          <h3>${post.title}</h3>
          <p>${post.content}</p>
          ${post.image ? `<img src="${post.image}" alt="Post Image" width="200">` : ""}
          ${post.video ? `<video controls width="200" src="${post.video}"></video>` : ""}
          <button onclick="editPost('${post._id}', '${post.title}', '${post.content}')">Edit</button>
          <button onclick="deletePost('${post._id}')">Delete</button>
        </div>
      `;
    });
    
  } catch (error) {
    console.error("Error fetching posts:", error);
    document.getElementById("posts-container").innerHTML = `
      <p class="error-message">⚠️ Error loading posts: ${error.message}</p>
    `;
  }
}

        // Function to delete a post
        async function deletePost(id) {
            if (confirm("Are you sure you want to delete this post?")) {
                try {
                    const response = await fetch(`/api/posts/${id}`, { 
                        method: "DELETE" 
                    });
                    if (!response.ok) {
                        throw new Error("Failed to delete post");
                    }
                    fetchPosts();  // Reload the posts after deletion
                } catch (error) {
                    console.error("Error deleting post:", error);
                    alert("Failed to delete post. Please try again.");
                }
            }
        }

        // Function to edit a post
        async function editPost(id, title, content) {
            const newTitle = prompt("Edit Title:", title);
            const newContent = prompt("Edit Content:", content);
            if (newTitle && newContent) {
                try {
                    const response = await fetch(`/api/posts/${id}`, {
                        method: "PUT",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({ 
                            title: newTitle, 
                            content: newContent 
                        })
                    });
                    if (!response.ok) {
                        throw new Error("Failed to update post");
                    }
                    fetchPosts();  // Reload posts after updating
                } catch (error) {
                    console.error("Error updating post:", error);
                    alert("Failed to update post. Please try again.");
                }
            }
        }

        // Function to show the form to add a new post
        function showAddPostForm() {
            document.getElementById("add-post-form").style.display = "block";
        }

        // Function to hide the add post form
        function cancelAddPost() {
            document.getElementById("add-post-form").style.display = "none";
        }

        // Function to add a new post
        async function addPost(event) {
            event.preventDefault();  // Prevent form from reloading the page
            
            const title = document.getElementById("post-title").value;
            const content = document.getElementById("post-content").value;
            const image = document.getElementById("post-image").files[0];
            const video = document.getElementById("post-video").files[0];

            const formData = new FormData();
            formData.append("title", title);
            formData.append("content", content);
            if (image) formData.append("image", image);
            if (video) formData.append("video", video);

            try {
                const response = await fetch("/api/posts", {
                    method: "POST",
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error("Failed to add post");
                }
                
                fetchPosts();  // Reload posts after adding new one
                cancelAddPost();  // Hide the add post form
                document.getElementById("post-form").reset(); // Reset form
            } catch (error) {
                console.error("Error adding post:", error);
                alert("Failed to add post. Please try again.");
            }
        }

        // Function to edit the footer
        function editFooter() {
            let currentText = document.getElementById("footer-text").innerText;
            let newText = prompt("Edit Footer Text:", currentText);

            if (newText) {
                document.getElementById("footer-text").innerText = newText;
                document.getElementById("footer-display").innerText = newText;
                localStorage.setItem("footerText", newText);
            }
        }

        // Load saved data on page load
        window.onload = function () {
            // Load header title
            const savedTitle = localStorage.getItem("headerTitle");
            if (savedTitle) {
                document.getElementById("header-title-text").textContent = savedTitle;
            }
            
            // Load logo
            const savedLogo = localStorage.getItem("blogLogo");
            if (savedLogo) {
                document.getElementById("header-logo").src = savedLogo;
            }
            
            // Load footer text
            const savedFooter = localStorage.getItem("footerText");
            if (savedFooter) {
                document.getElementById("footer-text").innerText = savedFooter;
                document.getElementById("footer-display").innerText = savedFooter;
            }
            
            // Load posts
            fetchPosts();
        };
    </script>
</body>
</html>